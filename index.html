<!DOCTYPE html>
<html>
<head>
    <title>–°–µ–º–µ–π–Ω—ã–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</title>
    <meta charset="UTF-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        video {
            width: 100%;
            max-width: 350px;
            height: 250px;
            background: #000;
            border-radius: 5px;
            border: 2px solid #ddd;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .room-input {
            margin: 20px 0;
            text-align: center;
        }
        input {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 200px;
            font-size: 16px;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            background: #e9ecef;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        h1 {
            text-align: center;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìû –°–µ–º–µ–π–Ω—ã–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ (P2P)</h1>
        
        <div class="room-input">
            <input type="text" id="roomInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã">
            <button onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</button>
        </div>

        <div class="controls">
            <button onclick="startCall()" id="startBtn" disabled>üé• –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            <button onclick="toggleVideo()" id="videoBtn">üìπ –í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ</button>
            <button onclick="toggleAudio()" id="audioBtn">üé§ –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
            <button onclick="hangUp()" id="hangupBtn" disabled>üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>

        <div id="status">–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å...</div>

        <div class="video-container">
            <div>
                <h3>–í–∞—à–µ –≤–∏–¥–µ–æ:</h3>
                <video id="localVideo" autoplay muted></video>
            </div>
            <div>
                <h3>–£–¥–∞–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ:</h3>
                <video id="remoteVideo" autoplay></video>
            </div>
        </div>
    </div>

    <script>
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–µ STUN —Å–µ—Ä–≤–µ—Ä–∞
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ]
        };

        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let isCallStarted = false;
        let roomId = null;

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const startBtn = document.getElementById('startBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const statusDiv = document.getElementById('status');

        // –ü—Ä–æ—Å—Ç–æ–π P2P –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—á–Ω–æ–π –æ–±–º–µ–Ω SDP
        function joinRoom() {
            roomId = document.getElementById('roomInput').value.trim();
            if (!roomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            
            startBtn.disabled = false;
            updateStatus(`‚úÖ –ö–æ–º–Ω–∞—Ç–∞: ${roomId}. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫"`);
            
            // –î–ª—è –¥–µ–º–æ - –∏–º–∏—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            setTimeout(() => {
                if (!isCallStarted) {
                    updateStatus('‚úÖ –ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é. –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ —Å —Ç–µ–º –∂–µ ID –∫–æ–º–Ω–∞—Ç—ã.');
                }
            }, 2000);
        }

        async function startCall() {
            try {
                updateStatus('üîÑ –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 },
                    audio: true 
                });
                
                localVideo.srcObject = localStream;
                
                isCallStarted = true;
                startBtn.disabled = true;
                hangupBtn.disabled = false;
                updateStatus('‚úÖ –ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç! –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');

                // –°–æ–∑–¥–∞–µ–º PeerConnection
                createPeerConnection();

                // –î–ª—è –¥–µ–º–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è SDP –≤—Ä—É—á–Ω—É—é
                showManualInstructions();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
            }
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(config);

            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                remoteVideo.srcObject = remoteStream;
                updateStatus('‚úÖ –í–∏–¥–µ–æ—Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
            };

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('–ù–æ–≤—ã–π ICE –∫–∞–Ω–¥–∏–¥–∞—Ç:', event.candidate);
                }
            };
        }

        function showManualInstructions() {
            updateStatus(`
                üîß –î–ª—è —Ä–∞–±–æ—Ç—ã –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –Ω—É–∂–µ–Ω —Å–∏–≥–Ω–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä.
                üì± –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ: 
                ${window.location.href}
                üÜî –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—Ç –∂–µ ID –∫–æ–º–Ω–∞—Ç—ã: ${roomId}
            `);
        }

        function hangUp() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
            }
            
            isCallStarted = false;
            startBtn.disabled = false;
            hangupBtn.disabled = true;
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            
            updateStatus('üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    document.getElementById('videoBtn').textContent = 
                        videoTrack.enabled ? 'üìπ –í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ' : 'üìπ –í–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ';
                }
            }
        }

        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    document.getElementById('audioBtn').textContent = 
                        audioTrack.enabled ? 'üé§ –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫' : 'üé§ –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
                }
            }
        }

        function updateStatus(message) {
            statusDiv.textContent = message;
        }

        document.getElementById('roomInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinRoom();
        });
    </script>
</body>
</html>
