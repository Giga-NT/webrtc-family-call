<!DOCTYPE html>
<html>
<head>
    <title>–°–µ–º–µ–π–Ω—ã–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</title>
    <meta charset="UTF-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        video {
            width: 100%;
            max-width: 350px;
            height: 250px;
            background: #000;
            border-radius: 5px;
            border: 2px solid #ddd;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .room-input {
            margin: 20px 0;
            text-align: center;
        }
        input {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 200px;
            font-size: 16px;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            background: #e9ecef;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        h1 {
            text-align: center;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìû –°–µ–º–µ–π–Ω—ã–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</h1>
        
        <div class="room-input">
            <input type="text" id="roomInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: family123)">
            <button onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</button>
        </div>

        <div class="controls">
            <button onclick="startCall()" id="startBtn" disabled>üé• –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            <button onclick="toggleVideo()" id="videoBtn">üìπ –í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ</button>
            <button onclick="toggleAudio()" id="audioBtn">üé§ –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
            <button onclick="hangUp()" id="hangupBtn" disabled>üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>

        <div id="status">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ...</div>

        <div class="video-container">
            <div>
                <h3>–í–∞—à–µ –≤–∏–¥–µ–æ:</h3>
                <video id="localVideo" autoplay muted></video>
            </div>
            <div>
                <h3>–£–¥–∞–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ:</h3>
                <video id="remoteVideo" autoplay></video>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è WebRTC
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const startBtn = document.getElementById('startBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const statusDiv = document.getElementById('status');

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let localStream = null;
        let peerConnections = {};
        let socket = null;
        let currentRoom = null;
        let isCallStarted = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO
        function initSocket() {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º URL —Å–µ—Ä–≤–µ—Ä–∞
            const serverUrl = window.location.origin;
            socket = io(serverUrl);
            
            socket.on('connect', () => {
                updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
            });

            socket.on('users-in-room', (users) => {
                console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ:', users);
                if (users.length > 0) {
                    startBtn.disabled = false;
                    updateStatus(`‚úÖ –í –∫–æ–º–Ω–∞—Ç–µ ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å(–µ–π). –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫"`);
                } else {
                    updateStatus('‚úÖ –í –∫–æ–º–Ω–∞—Ç–µ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç. –û–∂–∏–¥–∞–π—Ç–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö...');
                }
            });

            socket.on('user-connected', (userId) => {
                updateStatus(`üü¢ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è: ${userId}`);
                if (isCallStarted) {
                    createOffer(userId);
                }
            });

            socket.on('user-disconnected', (userId) => {
                updateStatus(`üî¥ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è: ${userId}`);
                if (peerConnections[userId]) {
                    peerConnections[userId].close();
                    delete peerConnections[userId];
                }
                remoteVideo.srcObject = null;
            });

            socket.on('webrtc-signal', async (data) => {
                if (!peerConnections[data.sender]) {
                    await createPeerConnection(data.sender);
                }
                
                try {
                    if (data.signal.type === 'offer') {
                        await peerConnections[data.sender].setRemoteDescription(data.signal);
                        await createAnswer(data.sender);
                    } else if (data.signal.type === 'answer') {
                        await peerConnections[data.sender].setRemoteDescription(data.signal);
                    } else if (data.signal.candidate) {
                        await peerConnections[data.sender].addIceCandidate(data.signal);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–∞:', error);
                }
            });
        }

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
        function joinRoom() {
            const roomId = document.getElementById('roomInput').value.trim();
            if (!roomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }

            currentRoom = roomId;
            initSocket();
            socket.emit('join-room', roomId);
            updateStatus(`üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ: ${roomId}`);
            startBtn.disabled = false;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ PeerConnection
        async function createPeerConnection(userId) {
            const pc = new RTCPeerConnection(config);
            peerConnections[userId] = pc;

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }

            // –ü–æ–ª—É—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞
            pc.ontrack = (event) => {
                const remoteStream = event.streams[0];
                remoteVideo.srcObject = remoteStream;
                updateStatus('‚úÖ –í–∏–¥–µ–æ—Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
            };

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('webrtc-signal', {
                        target: userId,
                        signal: {
                            type: 'candidate',
                            candidate: event.candidate
                        }
                    });
                }
            };

            return pc;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (offer)
        async function createOffer(userId) {
            const pc = await createPeerConnection(userId);
            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                socket.emit('webrtc-signal', {
                    target: userId,
                    signal: offer
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer:', error);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ (answer)
        async function createAnswer(userId) {
            const pc = peerConnections[userId];
            try {
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                socket.emit('webrtc-signal', {
                    target: userId,
                    signal: answer
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è answer:', error);
            }
        }

        // –ù–∞—á–∞–ª–æ –∑–≤–æ–Ω–∫–∞
        async function startCall() {
            try {
                updateStatus('üîÑ –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 },
                    audio: true 
                });
                
                localVideo.srcObject = localStream;
                
                isCallStarted = true;
                startBtn.disabled = true;
                hangupBtn.disabled = false;
                updateStatus('‚úÖ –ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç! –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');

                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                socket.emit('join-room', currentRoom);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.');
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
        function hangUp() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};
            
            isCallStarted = false;
            startBtn.disabled = false;
            hangupBtn.disabled = true;
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            
            updateStatus('üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω. –ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π.');
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ
        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    document.getElementById('videoBtn').textContent = 
                        videoTrack.enabled ? 'üìπ –í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ' : 'üìπ –í–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ';
                }
            }
        }

        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    document.getElementById('audioBtn').textContent = 
                        audioTrack.enabled ? 'üé§ –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫' : 'üé§ –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
                }
            }
        }

        function updateStatus(message) {
            statusDiv.textContent = message;
            console.log('Status:', message);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.getElementById('roomInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinRoom();
        });

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–æ –≤—Ä–µ–º—è –∑–≤–æ–Ω–∫–∞
        window.addEventListener('beforeunload', (e) => {
            if (isCallStarted) {
                hangUp();
            }
        });
    </script>
</body>
</html>