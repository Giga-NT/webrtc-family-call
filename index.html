<!DOCTYPE html>
<html>
<head>
    <title>–°–µ–º–µ–π–Ω—ã–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</title>
    <meta charset="UTF-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .room-input {
            text-align: center;
            margin: 30px 0;
        }
        input {
            padding: 12px 20px;
            margin: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 250px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus {
            border-color: #007bff;
            outline: none;
        }
        button {
            padding: 12px 25px;
            margin: 8px;
            border: none;
            border-radius: 8px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .controls {
            text-align: center;
            margin: 25px 0;
        }
        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 30px 0;
        }
        .video-wrapper {
            text-align: center;
        }
        video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: #000;
            border-radius: 10px;
            border: 3px solid #007bff;
        }
        #status {
            padding: 15px;
            margin: 20px 0;
            background: #e7f3ff;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            border-left: 4px solid #007bff;
        }
        .instructions {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìû –°–µ–º–µ–π–Ω—ã–π –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</h1>
        
        <div class="instructions">
            <strong>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong><br>
            1. –í–≤–µ–¥–∏—Ç–µ –ª—é–±–æ–π ID –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: family123)<br>
            2. –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ<br>
            3. –í–≤–µ–¥–∏—Ç–µ —Ç–æ—Ç –∂–µ ID –∫–æ–º–Ω–∞—Ç—ã<br>
            4. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫" –Ω–∞ –æ–±–æ–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
        </div>
        
        <div class="room-input">
            <input type="text" id="roomInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: family123)">
            <button onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</button>
        </div>

        <div id="status">–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å...</div>

        <div class="controls">
            <button onclick="startCall()" id="startBtn" disabled>üé• –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
            <button onclick="toggleVideo()" id="videoBtn">üìπ –í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ</button>
            <button onclick="toggleAudio()" id="audioBtn">üé§ –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
            <button onclick="hangUp()" id="hangupBtn" disabled>üìû –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>

        <div class="video-container">
            <div class="video-wrapper">
                <h3>–í–∞—à–µ –≤–∏–¥–µ–æ:</h3>
                <video id="localVideo" autoplay muted></video>
            </div>
            <div class="video-wrapper">
                <h3>–£–¥–∞–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ:</h3>
                <video id="remoteVideo" autoplay></video>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è WebRTC
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' }
            ]
        };

        let localStream = null;
        let peerConnection = null;
        let isCallStarted = false;
        let roomId = null;

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const startBtn = document.getElementById('startBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const statusDiv = document.getElementById('status');

        function updateStatus(message) {
            statusDiv.textContent = message;
            console.log('Status:', message);
        }

        function joinRoom() {
            roomId = document.getElementById('roomInput').value.trim();
            if (!roomId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            
            startBtn.disabled = false;
            updateStatus(`‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ: ${roomId}. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫"`);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–º–Ω–∞—Ç—É –≤ localStorage
            localStorage.setItem('webrtc-room', roomId);
        }

        async function startCall() {
            try {
                updateStatus('üîÑ –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 30 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ
                localVideo.srcObject = localStream;
                
                isCallStarted = true;
                startBtn.disabled = true;
                hangupBtn.disabled = false;
                updateStatus('‚úÖ –ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç! –ö–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∞–∫—Ç–∏–≤–Ω—ã.');

                // –°–æ–∑–¥–∞–µ–º PeerConnection –¥–ª—è –±—É–¥—É—â–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π
                createPeerConnection();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º:', error);
                
                if (error.name === 'NotAllowedError') {
                    alert('–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
                    updateStatus('‚ùå –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω');
                } else if (error.name === 'NotFoundError') {
                    alert('–ö–∞–º–µ—Ä–∞ –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
                    updateStatus('‚ùå –ö–∞–º–µ—Ä–∞ –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                } else {
                    alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º: ' + error.message);
                    updateStatus('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º');
                }
            }
        }

        function createPeerConnection() {
            // –≠—Ç–æ –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –±—É–¥—É—â–µ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è P2P —Å–≤—è–∑–∏
            // –°–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞
            peerConnection = new RTCPeerConnection(config);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ (–¥–ª—è –±—É–¥—É—â–µ–≥–æ)
            peerConnection.ontrack = (event) => {
                const remoteStream = event.streams[0];
                remoteVideo.srcObject = remoteStream;
                updateStatus('‚úÖ –í–∏–¥–µ–æ—Å–≤—è–∑—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
            };
        }

        function hangUp() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            isCallStarted = false;
            startBtn.disabled = false;
            hangupBtn.disabled = true;
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            
            updateStatus('üìû –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω. –ú–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π.');
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    document.getElementById('videoBtn').textContent = 
                        videoTrack.enabled ? 'üìπ –í—ã–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ' : 'üìπ –í–∫–ª—é—á–∏—Ç—å –≤–∏–¥–µ–æ';
                    updateStatus(videoTrack.enabled ? '‚úÖ –í–∏–¥–µ–æ –≤–∫–ª—é—á–µ–Ω–æ' : 'üìπ –í–∏–¥–µ–æ –≤—ã–∫–ª—é—á–µ–Ω–æ');
                }
            }
        }

        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    document.getElementById('audioBtn').textContent = 
                        audioTrack.enabled ? 'üé§ –í—ã–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫' : 'üé§ –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫';
                    updateStatus(audioTrack.enabled ? '‚úÖ –ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω' : 'üîá –ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω');
                }
            }
        }

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–Ω–∞—Ç—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            const savedRoom = localStorage.getItem('webrtc-room');
            if (savedRoom) {
                document.getElementById('roomInput').value = savedRoom;
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter
        document.getElementById('roomInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') joinRoom();
        });

        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', (e) => {
            if (isCallStarted) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
